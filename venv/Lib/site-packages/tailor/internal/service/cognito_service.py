from typing import List, Dict

import boto3
from rest.cognito.cognito_settings import CognitoSettings


class CognitoService:

    def __init__(self):
        self.client = boto3.client('cognito-idp')
        self.cognito_settings = CognitoSettings()

    def get_user_contact_information(self, username) -> Dict:
        attribs = self._get_user_attributes(username)

        output = {}
        for item in attribs:
            key = item['Name']
            value = item['Value']
            output[key] = value

        if "sub" in output:
            output.pop("sub")

        return output

    def find_groups_by_user(self, username) -> List[str]:
        groups = self._get_user_groups(username)
        return [d['GroupName'] for d in groups]

    def _get_user_groups(self, username: str) -> List[Dict]:
        response = self.client.admin_list_groups_for_user(
            Username=username,
            UserPoolId=self.cognito_settings.pool_id)
        groups = response["Groups"].copy()
        return groups

    def _get_user_attributes(self, username: str):
        response = self.client.admin_get_user(
            UserPoolId=self.cognito_settings.pool_id,
            Username=username
        )
        return response['UserAttributes']
